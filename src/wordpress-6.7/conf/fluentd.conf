<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>

<source>
 type tail
 path /appz/log/*
 path_key path
 format none
 read_from_head true
 pos_file /appz/log/fluent_pos.pos
 <parse>
   @type grok
    <grok>
      pattern (?<logtm>%{MONTHDAY}-%{MONTH}-%{YEAR} %{HOUR}:%{MINUTE}:%{SECOND}) %{LOGLEVEL:loglevel} \[%{DATA:thread}] %{GREEDYDATA:message}
    </grok>
    <grok>
      pattern %{GREEDYDATA:timestamp} %{LOGLEVEL:loglevel} %{GREEDYDATA:message}
    </grok>
    <grok>
      pattern (?<message>%{URIHOST:remote_host} - - \[%{HTTPDATE:request_time}] "%{WORD:method} %{NOTSPACE:request_page} HTTP/%{NUMBER:http_version}\" %{NUMBER:response_code} %{NUMBER:bytes} %{INT:time_taken} %{QS:referrer} %{QS:user_agent})
    </grok>
    <grok>
      pattern (?<message>%{NOTSPACE:check}:%{NOTSPACE:checkalert}%{GREEDYDATA})
    </grok>
  </parse>
 keep_time_key true
# time_format yyyy-MM-dd HH:mm:ss.SSSZ
 tag graylog2.*
</source>
<filter **>
  @type record_transformer
  enable_ruby
  <record>
   logtm ${record["logtm"]}
   thread ${record["thread"]}
   instance "#{Socket.gethostname}"
   namespace "#{ENV.fetch('APPZ_INSTANCE_PREFIX'){'default'}}"
   app "#{ENV.fetch('APPZ_APP_NAME'){'appz'}}"
   level ${if record["loglevel"] == "EMERG";record["level"] = "0" ; record["loglevel"] == "ALERT";record["level"] = "1";elsif record["loglevel"] == "CRIT" || record["loglevel"] == "SEVERE"; record["level"]= "2" ;elsif record["loglevel"] == "ERROR" ; record["level"]= "3" ;elsif record["loglevel"] == "WARN" || record["loglevel"] == "WARNING" ; record["level"]= "4" ;elsif record["loglevel"] == "NOTICE" ; record["level"]= "5";elsif record["loglevel"] == "INFO" ||  record["loglevel"] == nil ||  record["loglevel"] == 0 ; record["level"]= "6";else record["loglevel"] == "DEBUG" || record["loglevel"] == "debug"; record["level"]= "7";end}
  </record>
  @type record_modifier
  <replace>
    key message
    expression "#{ENV.fetch('APPZ_FLUENTD_SECRETS'){'byzantinez'}}"
    replace *****
  </replace>
</filter>

<match **>
 type graylog
 host "#{ENV.fetch('APPZ_LOG_HOST'){'GL'}}"
 port "#{ENV.fetch('APPZ_LOG_PORT'){12201}}"
# BufferedOutput config
 flush_interval 5
 num_threads 2
 # ...
</match>
